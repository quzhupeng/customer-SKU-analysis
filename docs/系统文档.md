# 产品客户价值分析系统 - 综合文档

**版本:** 2.1
**最后更新:** 2025-07-17

---

## 文档说明

本文档是产品客户价值分析系统的官方综合指南，旨在为产品、开发、测试和运维团队提供统一的信息参考。文档包含两大部分：

*   **第一部分：产品需求规格说明**
    *   详细定义了系统的项目目标、功能需求、技术规格和用户界面设计。
*   **第二部分：开发与修复历史**
    *   记录了系统从v1.0版本至今的主要开发、修复和优化过程，整合了所有相关的修复说明和技术细节。

---

# 第一部分：产品需求规格说明 (v2.0)

## 1. 项目概述

### 1.1 项目背景
基于现有产品客户价值分析系统框架，开发一个更加强大和复杂的分析系统，用于优化产品结构和客户结构，分析产品价值和客户价值，帮助公司决策哪些单品需要放弃，哪些客户需要放弃。

### 1.2 项目目标
- 提供多维度、多层次的数据分析能力
- 通过丰富的可视化图表呈现分析结果
- 支持产品、客户、地区三个维度的深度分析
- 帮助企业进行精准的产品和客户结构优化决策

## 2. 功能需求

### 2.1 数据上传与处理

#### 2.1.1 Excel文件上传
- 支持用户上传包含多个sheet的Excel文件
- 系统自动识别Excel中的sheet名称（如"分地区"、"分客户"、"分单品"等）
- 用户可选择要分析的具体sheet

#### 2.1.2 数据结构支持
系统需支持三种分析维度，每种维度对应不同的关键字段要求。Excel文件可能包含更多或更少的列，系统需要智能识别和匹配关键字段：

**分单品分析 - 必需关键字段：**
- 物料名称（或产品名称、存货名称、SKU等类似字段）
- 数量
- 毛利
- 其他可选字段：物料基本分类、单价、金额、成本、海运费、陆运费、代办费、吨毛利等

**分客户分析 - 必需关键字段：**
- 客户名称
- 数量
- 毛利
- 金额
- 其他可选字段：地区、单价、成本、海运费、陆运费、代办费、吨毛利等

**分地区分析 - 必需关键字段：**
- 地区
- 数量
- 毛利
- 其他可选字段：客户名称、单价、金额、成本、海运费、陆运费、代办费、吨毛利等

#### 2.1.3 字段识别规则
系统需要具备智能字段识别能力：
- 支持字段名称的模糊匹配（如"物料名称"、"产品名称"、"SKU"都应识别为产品字段）
- 支持中英文字段名称
- 当Excel包含额外列时，系统忽略非关键列
- 当缺少关键字段时，系统提示用户并拒绝处理
- 自动识别数值类型字段和文本类型字段

#### 2.1.4 数据单位转换风险控制
- **废除自动转换规则**：系统不再进行任何默认的单位自动转换。
- **新增强制确认步骤**：在数据上传成功、字段匹配完成之后，正式执行分析之前，系统必须弹出一个强制确认界面。
- **界面要求**：
    - 界面需清晰展示系统识别出的关键数值字段，特别是“数量”和“毛利/金额”。
    - 用户必须通过单选框手动确认这些字段的原始单位。
    - **示例**：
        - **数量单位确认**: 您上传的“数量”字段单位是？ (o) 千克 (kg)  ( ) 吨 (t)
        - **金额单位确认**: 您上传的“毛利”、“金额”字段单位是？ (o) 元  ( ) 万元
- **处理逻辑**：系统严格根据用户在确认界面中的选择来执行后续的单位转换计算（如 kg -> t, 元 -> 万元）或跳过转换。只有用户完成确认后，才能进入分析页面。

### 2.2 分析维度选择
用户上传Excel后，系统提供三个分析维度选择：
- 分单品分析
- 分客户分析
- 分地区分析

## 3. 分析功能详细需求

### 3.1 分单品分析

#### 3.1.1 核心分析指标
- 销量（吨）
- 吨毛利（元/吨）
- 总金额（万元）
- 总毛利（万元）
- 成本分析指标（辅助分析）：
  - 总成本（万元）= 成本 + 海运费 + 陆运费 + 代办费
  - 成本率 = 总成本/总金额
  - 成本构成分析（成本、海运费、陆运费、代办费占比）

#### 3.1.2 可视化分析图表

**1. 四象限散点图分析与策略洞察**
- **图表设计**：
    - X轴：销量（吨）
    - Y轴：吨毛利（元/吨）
    - 散点大小：可表示总金额或总毛利
    - 四象限划分：以销量和吨毛利的加权平均值为分割线。
- **策略洞察卡片**：
    - 在四象限图的下方，并排展示四个“策略洞察卡片”，每个卡片对应一个象限。
    - **卡片内容**：象限名称、特征、产品数量、基础策略建议。
    - **策略详情**：
        - **象限I (明星产品)**: 高毛利, 高销量。策略: 重点保护与投入，保证产能、优先备货、加大营销。
        - **象限II (潜力产品)**: 高毛利, 低销量。策略: 精准营销与试错，分析销量低的原因。
        - **象限III (瘦狗产品)**: 低毛利, 低销量。策略: 简化或淘汰，评估战略保留价值。
        - **象限IV (金牛产品)**: 低毛利, 高销量。策略: 优化成本与关联销售，审视生产流程，利用其流量。

**2. 帕累托分析（80/20法则）**
- **功能整合**: 将原有的“贡献度分析”和“帕累托图”合并，形成一个标准的帕累托分析图。
- **图表设计**:
    - **条形图**: 显示每个项目的独立贡献值（如毛利、销量、金额）。
    - **折线图**: 显示累计贡献百分比。
    - **双Y轴**: 左轴对应独立贡献值，右轴对应累计百分比。
    - **80/20分界线**: 虚线标记80%分界点。
- **交互功能**:
    - **维度切换**: 支持用户在“毛利”、“销量”、“金额”等维度间动态切换。
    - **统计信息**: 在图表下方显示核心统计数据（如核心项目数、占比、80%分界点等）。

**3. 盈亏分析**
- 识别并标记亏损产品（毛利为负的产品）。
- 可视化展示盈利产品vs亏损产品分布。
- **联动筛选**: 点击盈亏分析图表可筛选四象限散点图中的对应数据点。

**4. 其他辅助图表**
- **销量分布区间分析**: 可视化展示不同销量区间的产品分布。
- **成本分析图表**: 成本构成饼图、成本率分布图、成本效率散点图。

#### 3.1.3 明细数据查看
- 支持点击图表查看具体产品明细。
- 提供产品明细表格，包含所有字段信息。
- 支持按各字段排序和筛选。

### 3.2 分客户分析
（需求与分单品分析类似，核心指标变为采购金额、毛利贡献等）

### 3.3 分地区分析
（需求与分单品分析类似，核心指标变为地区销售额、地区毛利贡献等）

## 4. 技术需求

### 4.1 前端技术栈
- HTML5 + CSS3 + JavaScript
- 图表库：ECharts
- 响应式设计，支持多设备访问

### 4.2 后端技术栈
- Python Flask 框架
- pandas 用于数据处理
- openpyxl 用于Excel文件处理

## 5. 用户界面需求

### 5.1 分析页面布局
采用“由主到次，由宏观到微观”的布局思路：
- **页面顶部**: 放置核心的“四象限散点图”和“帕累托分析图”。
- **页面中部**: 放置补充分析图表，如“盈亏分析”和“分布区间图”。
- **页面底部**: 放置“明细数据表格”，支持与上方所有图表进行联动筛选。

### 5.2 交互设计
- 图表支持缩放、平移、点击交互。
- 数据表格支持排序、筛选、分页。
- 支持图表和数据的联动显示。

## 6. 导出功能需求

### 6.1 导出Excel报告结构
将导出的Excel报告结构最终确定为以下四个Sheet：
- **Sheet 1: “分析概要 (Report)”**: 作为报告的封面。
- **Sheet 2: “可视化图表 (Charts)”**: 包含分析页面生成的所有核心图表的静态图片。
- **Sheet 3: “分析结果数据 (Analyzed Data)”**: 经过聚合后的分析数据，并新增[象限归类]和[建议策略]列。
- **Sheet 4: “原始数据 (含标注)”**: 完整复制用户上传的原始数据，并在最后一列为每一行数据动态标注其所属的象限归类。

---

# 第二部分：开发与修复历史 (v1.0 -> v2.1)

## 修复概述

本部分记录了系统自v1.0版本以来的主要修复、优化和功能完善过程，旨在为后续的开发和维护提供清晰的技术参考。

## 1. 核心功能修复与增强

### 1.1 四象限散点图综合修复

#### 1.1.1 象限编号修正
- **问题**: 象限编号不符合标准笛卡尔坐标系（逆时针）规则，导致策略与象限错配。
- **解决方案**:
    - **后端 (`utils.py`)**: 修改 `calculate_quadrant` 函数，严格按照 `右上(I) -> 左上(II) -> 左下(III) -> 右下(IV)` 的顺序进行编号。
    - **前端 (`app.js`)**: 调整配色方案，确保与新编号对应：
        - **象限I (明星)**: 红色
        - **象限II (潜力)**: 橙色
        - **象限III (瘦狗)**: 灰色
        - **象限IV (金牛)**: 绿色

#### 1.1.2 分割线与统计逻辑修正
- **问题**:
    1.  散点图分割线（平均值）无法正确显示。
    2.  “��毛利”的平均值计算错误，未使用加权平均，导致分割线不准。
- **解决方案**:
    - **前端 (`app.js`)**: 使用ECharts的 `markLine` 属性替代原有的 `graphic` 组件，以正确绘制分割线。
    - **后端 (`analyzer.py`)**:
        - **分割线**: 对于“吨毛利”，平均值采用 `(毛利总和 / 数量总和)` 的加权方式计算。
        - **统计信息**: 各象限的“吨毛利”也同样采用加权平均计算，确保数据准确性。

#### 1.1.3 统计信息动态显示
- **问题**: 统计卡片内容固定，无法根据“分单品”或“分客户”等不同分析类型动态展示相应指标。
- **解决方案**:
    - **前端 (`app.js`)**: 创建 `getSecondStatGroup` 和 `getThirdStatGroup` 等辅助函数，根据全局变量 `currentAnalysisType` 动态生成HTML，以显示正确的指标（如“吨毛利”vs“毛利贡献”，“销量”vs“销售额”）。

### 1.2 帕累托分析功能整合与优化

- **问题**: 原有两个功能重叠的图表：“贡献度分析图”和“帕累托图”，界面冗余且不符合标准。
- **解决方案**:
    - **功能整合**: 废弃“贡献度分析图”，将其功能整合进“帕累托图”。
    - **标准帕累托图**:
        - **条形图**: 显示个体贡献。
        - **折线图**: 显示累计贡献百分比。
        - **双Y轴**: 分别对应数值和百分比。
    - **维度切换**: 在图表上方添加下拉框，允许用户在“毛利”、“销量”、“金额”等维度间自由切换，无需重新分析。
    - **布局优化**: 将帕累托图调整为全宽显示，并优化其 `grid` 配置，大幅提升空间利用率。
    - **统计信息**: 在图表下方增加详细的统计面板，显示核心项目数、占比、80/20分界点等关键信息。

### 1.3 盈亏分析与散点图联动修复
- **问题**: 点击盈亏分析环形图后，散点图无法正确筛选显示对应的数据点。
- **解决方案**:
    - **增强前端筛选 (`app.js`)**: 筛选逻辑不再依赖单一字段名，而是会尝试从 `group`, `index`, `name` 及动态获取的字段名中进行匹配，增强了容错性。
    - **增强后端数据 (`analyzer.py`)**: 在返回给前端的数据中，统一添加 `group` 字段作为主要的关联标识符，确保前后端数据一致性。

## 2. 数据处理与验证修复

### 2.1 字段识别与验证优化
- **问题**: 字段识别别名库不全，且验证逻辑过于严格，影响易用性。
- **解决方案 (`utils.py`)**:
    - **扩展别名库**: 大幅增加 `product`, `customer`, `region` 等关键字段的常见别名。
    - **优化验证逻辑**: 将必需字段的验证规则从“必须全部存在”放宽为“核心维度字段 + 至少一个数值字段”，使分析更灵活。
    - **增强识别算法**: 引入模糊匹配和关键字匹配，进一步提升自动识别的准确率。

### 2.2 文件上传错误修复
- **问题**: 上传包含中文或特殊字符的文件名时，因 `secure_filename` 函数处理后为空或无效字符，导致文件保存失败。
- **解决方案 (`app.py`)**:
    - 在保存文件前，检查 `secure_filename` 的处理结果。
    - 如果返回结果为空或无效，则使用一个安全的默认文件名（如 `uploaded_file.xlsx`），并保留原始文件的扩展名，确保上传流程总能成功。

## 3. 用户界面与体验优化

### 3.1 明细数据表结构优化
- **问题**: 底部的明细数据表字段混乱，缺乏格式化和排序功能。
- **解决方案 (`app.js`, `style.css`)**:
    - **动态配置**: 使用 `getTableFieldConfig` 函数根据分析类型动态确定表格的列、顺序和样式。
    - **数据格式化**: 新增 `formatTableValue` 函数，对数值、货币、百分比等进行标准化格式显示。
    - **排序功能**: 添加 `sortTable` 函数，允许用户点击表头对任意列进行升序或降序排列。
    - **样式优化**: 优化了列宽、���齐方式，并为象限名称添加了颜色标识，提升可读性。

### 3.2 布局与文字显示优化
- **问题**: 统计信息卡片中的文字因空间不足或CSS截断规则导致显示不全。
- **解决方案 (`style.css`)**:
    - **移除截断**: 取消了 `overflow: hidden` 和 `text-overflow: ellipsis` 规则。
    - **允许换行**: 设置 `white-space: normal` 和 `word-wrap: break-word`，确保长文本能完整显示。
    - **优化布局**: 调整了flex布局和间距，为标签和数值提供了充足的显示空间。
    - **紧凑化**: 在确保可读性的前提下，微调了字体大小、行高和内边距，使整体布局更紧凑、专业。

## 4. 附录：关键代码片段

### 附录A: 修正后的象限计算
```python
# utils.py
def calculate_quadrant(x_value: float, y_value: float, x_avg: float, y_avg: float) -> int:
    if x_value >= x_avg and y_value >= y_avg:
        return 1  # 第一象限：高X，高Y
    elif x_value < x_avg and y_value >= y_avg:
        return 2  # 第二象限：低X，高Y
    elif x_value < x_avg and y_value < y_avg:
        return 3  # 第三象限：低X，低Y
    else:
        return 4  # 第四象限：高X，低Y
```

### 附录B: 帕累托维度切换逻辑
```javascript
// static/js/app.js
function handleParetoDimensionChange() {
    const selectedDimension = paretoDimensionSelector.value;
    // ... (省略部分代码)
    fetch(`/analyze?file=${encodeURIComponent(currentFile)}&sheet=${encodeURIComponent(currentSheet)}&type=${currentAnalysisType}&pareto_dimension=${selectedDimension}`)
        .then(response => response.json())
        .then(data => {
            // ... 更新帕累托图表和统计信息
            displayParetoChart(data.pareto_analysis);
            displayParetoStats(data.pareto_analysis);
        })
        .catch(error => console.error('帕累托维度切换失败:', error));
}
```